<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Data Cleanup Tool</title>
    <!-- Google Fonts for Myanmar support -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            margin: 20px;
            background: #f8fafc;
            color: #1f2937;
            line-height: 1.6;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto;
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1f2937;
            font-weight: 700;
            margin-bottom: 24px;
        }
        button { 
            padding: 12px 24px; 
            margin: 10px; 
            background: #2563eb; 
            color: white; 
            border: none; 
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .danger { 
            background: #ef4444; 
        }
        .danger:hover {
            background: #dc2626;
        }
        .log { 
            background: #f9fafb; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            border: 1px solid #e5e7eb;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { 
            background: #f0fdf4;
            border-color: #86efac;
        }
        .error { 
            background: #fef2f2;
            border-color: #fca5a5;
        }
        /* Myanmar text support */
        .myanmar-text {
            font-family: 'Noto Sans Myanmar', 'Myanmar Text', sans-serif;
            font-size: 14px;
            line-height: 1.8;
        }
        /* Log entry with Myanmar text */
        .log-entry {
            margin: 4px 0;
            padding: 4px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-entry .myanmar {
            font-family: 'Noto Sans Myanmar', 'Myanmar Text', sans-serif;
            padding: 0 4px;
            font-size: 14px;
        }
        /* Status icons */
        .emoji {
            font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
            font-size: 16px;
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Firebase Data Cleanup Tool</h1>
        <p>This tool will clean up corrupted Myanmar text in Firebase and re-add properly encoded data.</p>
        
        <button onclick="checkCorruptedData()">Check Corrupted Data</button>
        <button onclick="cleanupAndRemigrate()" class="danger">Delete All & Re-migrate</button>
        
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDOT1jC27f26f3BIW-yFcgHTLGdEWeiopQ",
            authDomain: "mm-kr-expo.firebaseapp.com",
            projectId: "mm-kr-expo",
            storageBucket: "mm-kr-expo.firebasestorage.app",
            messagingSenderId: "974504645463",
            appId: "1:974504645463:web:0cd68a7b52ea2bcddb6412"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Clean dictionary data with proper Myanmar fonts
        const cleanDictionaryEntries = [
            { korean: 'ÏïàÎÖïÌïòÏÑ∏Ïöî', myanmar: '·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´', english: 'Hello', pos: 'interjection' },
            { korean: 'Í∞êÏÇ¨Ìï©ÎãàÎã§', myanmar: '·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äê·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫', english: 'Thank you', pos: 'interjection' },
            { korean: 'ÎÑ§', myanmar: '·Äü·ÄØ·Äê·Ä∫·ÄÄ·Ä≤·Ä∑', english: 'Yes', pos: 'interjection' },
            { korean: 'ÏïÑÎãàÏöî', myanmar: '·Äô·Äü·ÄØ·Äê·Ä∫·Äò·Ä∞·Ä∏', english: 'No', pos: 'interjection' },
            { korean: 'ÏùåÏãù', myanmar: '·Ä°·ÄÖ·Ä¨·Ä∏·Ä°·Äû·Ä±·Ä¨·ÄÄ·Ä∫', english: 'Food', pos: 'noun' },
            { korean: 'Î¨º', myanmar: '·Äõ·Ä±', english: 'Water', pos: 'noun' },
            { korean: 'ÌïôÍµê', myanmar: '·ÄÄ·Äª·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏', english: 'School', pos: 'noun' },
            { korean: 'ÏπúÍµ¨', myanmar: '·Äû·Ä∞·ÄÑ·Äö·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Ä∏', english: 'Friend', pos: 'noun' },
            { korean: 'ÏÇ¨Îûë', myanmar: '·ÄÅ·Äª·ÄÖ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏', english: 'Love', pos: 'noun' },
            { korean: 'Í∞ÄÏ°±', myanmar: '·Äô·Ä≠·Äû·Ä¨·Ä∏·ÄÖ·ÄØ', english: 'Family', pos: 'noun' },
        ];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            
            // Create a new log entry div
            const entryDiv = document.createElement('div');
            entryDiv.className = 'log-entry';
            entryDiv.innerHTML = `[${timestamp}] ${message}`;
            
            // Add to log and maintain scroll
            logDiv.appendChild(entryDiv);
            logDiv.className = `log ${type}`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        window.checkCorruptedData = async function() {
            log('Checking for corrupted data...');
            
            try {
                const snapshot = await getDocs(collection(db, 'dictionary'));
                
                if (snapshot.empty) {
                    log('No dictionary words found.', 'info');
                    return;
                }

                log(`Found ${snapshot.size} words. Checking for corruption...`);
                
                let corruptedCount = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const myanmar = data.myanmar || '';
                    
                    // Check if Myanmar text contains garbled characters
                    if (myanmar.includes('√¢‚Ç¨') || myanmar.includes('√É¬°') || myanmar.length === 0) {
                        corruptedCount++;
                        log(`‚ùå Corrupted: ${data.korean} ‚Üí "${myanmar}" (garbled)`, 'error');
                    } else {
                        log(`‚úÖ Clean: ${data.korean} ‚Üí <span class="myanmar">${myanmar}</span>`);
                    }
                });
                
                if (corruptedCount > 0) {
                    log(`\n‚ö†Ô∏è  Found ${corruptedCount} corrupted entries. Use "Delete All & Re-migrate" to fix.`, 'error');
                } else {
                    log('\n‚úÖ All data looks clean!', 'success');
                }
                
            } catch (error) {
                log(`Error checking data: ${error.message}`, 'error');
            }
        };

        window.cleanupAndRemigrate = async function() {
            if (!confirm('This will delete ALL dictionary data and re-add clean data. Continue?')) {
                return;
            }
            
            log('Starting cleanup and re-migration...');
            
            try {
                // Step 1: Delete all existing dictionary data
                log('Deleting existing dictionary data...');
                const snapshot = await getDocs(collection(db, 'dictionary'));
                
                for (const docSnapshot of snapshot.docs) {
                    await deleteDoc(doc(db, 'dictionary', docSnapshot.id));
                    log(`üóëÔ∏è  Deleted: ${docSnapshot.id}`);
                }
                
                log(`Deleted ${snapshot.size} existing entries.`);
                
                // Step 2: Add clean data with proper encoding
                log('Adding clean data with proper encoding...');
                let successCount = 0;
                
                for (const entry of cleanDictionaryEntries) {
                    try {
                        // Ensure proper UTF-8 encoding
                        const cleanKorean = entry.korean.normalize('NFC');
                        const cleanMyanmar = entry.myanmar.normalize('NFC');
                        
                        await addDoc(collection(db, 'dictionary'), {
                            korean: cleanKorean,
                            myanmar: cleanMyanmar,
                            english: entry.english || '',
                            pos: entry.pos || 'noun',
                            addedBy: 'cleanup_migration',
                            addedAt: serverTimestamp(),
                            source: 'clean_migration'
                        });
                        
                        successCount++;
                        log(`‚úÖ Added: ${cleanKorean} ‚Üí <span class="myanmar">${cleanMyanmar}</span>`);
                        
                    } catch (error) {
                        log(`‚ùå Failed to add: ${entry.korean} - ${error.message}`, 'error');
                    }
                }

                log(`\nüéâ Cleanup completed!`, 'success');
                log(`‚úÖ Successfully added: ${successCount} clean entries`);
                log(`\nüí° Now test your app - Myanmar text should display correctly!`);

            } catch (error) {
                log(`Cleanup failed: ${error.message}`, 'error');
            }
        };
    </script>
</body>
</html>